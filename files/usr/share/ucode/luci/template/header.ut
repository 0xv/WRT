{#
 Copyright 2022 Jo-Philipp Wich <jo@mein.io>
 Licensed to the public under the Apache License 2.0.
-#}
{%
	include(`themes/${theme}/header`);
-%}
<script src="{{ resource }}/luci.js?v=25.017.24510~d42ec55"></script>
<script src="{{ resource }}/sweetalert2.all.min.js"></script>
<script>
	L = new LuCI({{ replace(`${ {
		media          : media,
		resource       : resource,
		scriptname     : http.getenv("SCRIPT_NAME"),
		pathinfo       : http.getenv("PATH_INFO"),
		documentroot   : http.getenv("DOCUMENT_ROOT"),
		requestpath    : ctx.request_path,
		dispatchpath   : ctx.path,
		pollinterval   : +config.main.pollinterval || 5,
		ubuspath       : config.main.ubuspath || '/ubus/',
		sessionid      : ctx.authsession,
		token          : ctx.authtoken,
		nodespec       : dispatched,
		apply_rollback : max(+config.apply.rollback ||  90, 90),
		apply_holdoff  : max(+config.apply.holdoff  ||   4,  1),
		apply_timeout  : max(+config.apply.timeout  ||   5,  1),
		apply_display  : max(+config.apply.display  || 1.5,  1),
		rollback_token : rollback_token
	} }`, '/', '\\/') }});
</script>
<style>
    .update-info {
        text-align: left;
        margin: 15px 0;
        font-family: Arial, sans-serif;
    }
    .update-info p {
        margin: 8px 0;
        color: #333;
    }
    
    .changelog {
        font-family: Arial, sans-serif;
        font-size: 14px;
        color: #333;
        line-height: 1.6;
        margin-top: 20px;
        padding: 10px;
        border-left: 4px solid #007BFF;
        max-height: 250px;
        overflow-y: auto;
        border-radius: 5px;
    }
    .changelog pre {
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.5;
    }
    .swal2-popup {
        font-family: Arial, sans-serif;
        max-width: 600px;
    }
    .swal2-title {
        font-size: 1.6em;
        margin-bottom: 15px;
        color: #007BFF;
        background-color: #FFFFFF;
        background: #FFFFFF;
    }
    
    .swal2-html-container {
        background-color: #FFFFFF;
        background: #FFFFFF;
    }
    .swal2-html-container a {
        text-decoration: none;
        color: #007BFF;
    }
    .swal2-html-container a:hover {
        text-decoration: underline;
    }
    .square-wrapper {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1000;
    }
    .square {
        border: 1px solid #5e42a6;
        height: 26px;
        width: 26px;
        display: block;
        transform: rotate(45deg);
        overflow: hidden;
        cursor: pointer;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square .burgerwrap {
        height: 18px;
        width: 21px;
        transform: rotate(-45deg);
        padding-left: 2px;
        padding-top: 8px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square:hover {
        transform: rotate(135deg);
        border: 1px solid rgb(61, 14, 230);
    }
    .square:hover .burgerwrap {
        transform: rotate(-135deg);
    }
    .square span {
        height: 2px;
        width: 14px;
        background: linear-gradient(145deg, #5e42a6, #b46be4);
        display: block;
        margin-bottom: 2px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square span:after {
        content: "";
        height: 2px;
        width: 14px;
        position: absolute;
        background: rgb(61, 14, 230);
        left: -22px;
        margin-top: -4px;
        transition: all 500ms cubic-bezier(0.97, 0, 0.395, 0.995);
    }
    .square:hover span {
        margin-left: 26px;
    }
    .square:hover span:after {
        left: 0.2px;
    }
    .square span:nth-of-type(1),
    .square span:nth-of-type(1):after {
        transition-delay: 0.1s;
    }
    .square span:nth-of-type(2),
    .square span:nth-of-type(2):after {
        transition-delay: 0.2s;
    }
    .square span:nth-of-type(3),
    .square span:nth-of-type(3):after {
        transition-delay: 0.3s;
    }
</style>

<script>

// ====== Global Configuration ======
const CONFIG = {
    APP: {
        name: 'RTA-WRT',
        checkInterval: 15 * 60 * 1000, // Increased to 15 minutes
        offlineRetryInterval: 60 * 1000, // Increased to 1 minute
        maxRetryAttempts: 3,
        cacheExpiration: 24 * 60 * 60 * 1000,
        minRetryDelay: 1000,
        maxRetryDelay: 10000
    },
    URLS: {
        info: 'https://api.allorigins.win/raw?url=https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT/refs/heads/info/informasi.txt',
        internetCheck: 'https://www.google.com/favicon.ico'
    },
    SOCIAL: {
        channel: 'https://t.me/rtawrt',
        group: 'https://t.me/backup_rtawrt',
        personal: 'https://t.me/RizkiKotet'
    },
    STORAGE_KEYS: {
        LAST_INFO: 'lastInformation',
        LAST_INFO_DATE: 'lastInformationDate',
        MODAL_KEY: 'mdl_Saweria'
    }
};

// ====== Utility Functions ======
const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};

// ====== Storage Manager ======
class StorageManager {
    static #memoryCache = new Map();

    static save(key, value) {
        try {
            this.#memoryCache.set(key, value);
            localStorage.setItem(key, value);
            return true;
        } catch (error) {
            console.warn(`Storage error: ${error}`);
            return false;
        }
    }

    static get(key) {
        if (this.#memoryCache.has(key)) {
            return this.#memoryCache.get(key);
        }
        const value = localStorage.getItem(key);
        if (value) this.#memoryCache.set(key, value);
        return value;
    }

    static remove(key) {
        this.#memoryCache.delete(key);
        localStorage.removeItem(key);
    }

    static clear() {
        this.#memoryCache.clear();
        localStorage.clear();
    }
}

// ====== Connection Manager ======
class ConnectionManager {
    static #isOnline = navigator.onLine;
    static #retryCount = 0;

    static get isOnline() {
        return this.#isOnline;
    }

    static async checkConnection() {
        if (!navigator.onLine) {
            this.#isOnline = false;
            return false;
        }

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            await fetch(CONFIG.URLS.internetCheck, {
                mode: "no-cors",
                cache: 'no-store',
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            this.#retryCount = 0;
            this.#updateConnectionState(true);
            return true;
        } catch {
            this.#updateConnectionState(false);
            return false;
        }
    }

    static #updateConnectionState(isOnline) {
        if (this.#isOnline !== isOnline) {
            this.#isOnline = isOnline;
            window.dispatchEvent(new CustomEvent('connectionChange', { 
                detail: { isOnline } 
            }));
        }
    }

    static async retryWithBackoff(operation) {
        const baseDelay = CONFIG.APP.minRetryDelay;
        const maxDelay = CONFIG.APP.maxRetryDelay;

        for (let i = 0; i < CONFIG.APP.maxRetryAttempts; i++) {
            try {
                return await operation();
            } catch (error) {
                if (i === CONFIG.APP.maxRetryAttempts - 1) throw error;
                const delay = Math.min(baseDelay * Math.pow(2, i), maxDelay);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
}

// ====== Information Manager ======
class InformationManager {
    static #lastCheck = 0;
    static #checkThrottle = 5000; // 5 seconds minimum between checks

    static async checkInformation() {
        const now = Date.now();
        if (now - this.#lastCheck < this.#checkThrottle) return;
        this.#lastCheck = now;

        if (!ConnectionManager.isOnline) {
            const cachedInfo = StorageManager.get(CONFIG.STORAGE_KEYS.LAST_INFO);
            if (cachedInfo) this.#processInformation(cachedInfo);
            return;
        }

        try {
            const response = await fetch(CONFIG.URLS.info, {
                cache: 'no-store'
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const infoContent = await response.text();
            StorageManager.save('lastModified', response.headers.get('Last-Modified'));
            this.#processInformation(infoContent);
        } catch (error) {
            console.warn('Failed to fetch information:', error);
        }
    }

    static #processInformation(infoContent) {
        const currentContent = StorageManager.get(CONFIG.STORAGE_KEYS.LAST_INFO);
        const today = new Date().toDateString();
        
        if (infoContent !== currentContent && 
            StorageManager.get(CONFIG.STORAGE_KEYS.LAST_INFO_DATE) !== today) {
            this.#showInformationAlert(infoContent, today);
        }
    }

    static async #showInformationAlert(infoContent, today) {
        await AlertSystem.enqueueAlert({
            title: '🚀 Informasi',
            width: 400,
            html: `
                <div class="changelog" style="margin-top: 15px; text-align: left; white-space: pre-line;">
                    <div>${infoContent}</div>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Mengerti',
            cancelButtonText: '❌ Tutup',
            onConfirm: () => {
                StorageManager.save(CONFIG.STORAGE_KEYS.LAST_INFO, infoContent);
                StorageManager.save(CONFIG.STORAGE_KEYS.LAST_INFO_DATE, today);
            }
        });
    }
}


// ====== Alert System ======
class AlertSystem {
    static #queue = [];
    static #isShowing = false;

    static async enqueueAlert(alertConfig) {
        this.#queue.push(alertConfig);
        await this.#processQueue();
    }

    static async #processQueue() {
        if (this.#isShowing || this.#queue.length === 0) return;

        this.#isShowing = true;
        const alertConfig = this.#queue.shift();

        try {
            const result = await Swal.fire(alertConfig);
            if (result.isConfirmed && alertConfig.onConfirm) {
                await alertConfig.onConfirm(result);
            }
        } catch (error) {
            console.warn('Alert error:', error);
        } finally {
            this.#isShowing = false;
            await this.#processQueue();
        }
    }
}

// ====== Profile Manager ======
function showProfile() {
    AlertSystem.enqueueAlert({
        width: 400,
        title: "About Me!",
        text: "Halo! Saya Rizki Kotet, seorang programmer pemula yang belajar C# dan PHP. Saya memiliki pemahaman dasar tentang front-end dan back-end. Saat ini, saya sedang mengerjakan proyek Custom OpenWrt dan ImmortalWrt. Saya selalu bersemangat untuk belajar hal baru di dunia teknologi!",
        imageUrl: "{{ resource }}/Profile.jpeg",
        imageWidth: 200,
        imageHeight: 200,
        imageAlt: "Profile",
        allowOutsideClick: false,
        footer: `
            <p style="text-align: center;">
                <a href="${CONFIG.SOCIAL.channel}"><img alt="Channel" src="{{ resource }}/Channel.svg" width="110" height="30"></a>
                <a href="${CONFIG.SOCIAL.group}"><img alt="Group" src="{{ resource }}/Group.svg" width="110" height="30"></a>
                <a href="${CONFIG.SOCIAL.personal}"><img alt="Personal" src="{{ resource }}/Personal.svg" width="110" height="30"></a>
            </p>
        `
    });
}

// ====== Daily Modal Manager ======
class DailyModalManager {
    static async showDailyModal() {
        const today = new Date().toDateString();
        if (StorageManager.get(CONFIG.STORAGE_KEYS.MODAL_KEY) === today) return;

        await AlertSystem.enqueueAlert({
            title: `🚀 Welcome To ${CONFIG.APP.name}`,
            width: 400,
            imageUrl: "{{ resource }}/Saweria.png",
            imageWidth: 200,
            imageHeight: 200,
            imageAlt: "Saweria",
            html: `
                <p style="text-align: center;">
                    <a href="${CONFIG.SOCIAL.channel}" target="_blank"><img alt="Channel" src="{{ resource }}/Channel.svg" width="110" height="20"></a>
                    <a href="${CONFIG.SOCIAL.group}" target="_blank"><img alt="Group" src="{{ resource }}/Group.svg" width="110" height="20"></a>
                    <a href="${CONFIG.SOCIAL.personal}" target="_blank"><img alt="Personal" src="{{ resource }}/Personal.svg" width="110" height="20"></a>
                </p>
                <div style="margin-top: 10px; text-align: center;">
                    <input type="checkbox" id="noShowToday">
                    <label for="noShowToday">Jangan tampilkan lagi hari ini</label>
                </div>
            `,
            confirmButtonText: 'OK',
            allowOutsideClick: false,
            didOpen: () => {
                document.getElementById('noShowToday').addEventListener('change', event => {
                    if (event.target.checked) {
                        StorageManager.save(CONFIG.STORAGE_KEYS.MODAL_KEY, today);
                    } else {
                        StorageManager.remove(CONFIG.STORAGE_KEYS.MODAL_KEY);
                    }
                });
            }
        });
    }
}

// ====== Application Controller ======
class AppController {
    static #checkTimer = null;

    static async initialize() {
        // Setup event listeners
        window.addEventListener('online', this.#handleConnectionChange.bind(this));
        window.addEventListener('offline', this.#handleConnectionChange.bind(this));
        document.addEventListener('visibilitychange', this.#handleVisibilityChange.bind(this));
        
        // Initial setup
        await ConnectionManager.checkConnection();
        if (ConnectionManager.isOnline) {
            await DailyModalManager.showDailyModal();
            await this.#startInformationChecker();
        }
    }

    static async #handleConnectionChange() {
        const isOnline = await ConnectionManager.checkConnection();
        if (isOnline) {
            await this.#startInformationChecker();
        } else {
            this.#stopInformationChecker();
        }
    }

    static #handleVisibilityChange() {
        if (document.visibilityState === 'visible' && ConnectionManager.isOnline) {
            this.#startInformationChecker();
        } else {
            this.#stopInformationChecker();
        }
    }

    static async #startInformationChecker() {
        this.#stopInformationChecker();
        await InformationManager.checkInformation();
        this.#checkTimer = setInterval(
            () => InformationManager.checkInformation(),
            CONFIG.APP.checkInterval
        );
    }

    static #stopInformationChecker() {
        if (this.#checkTimer) {
            clearInterval(this.#checkTimer);
            this.#checkTimer = null;
        }
    }
}

// ====== Initialize Application ======
document.addEventListener('DOMContentLoaded', () => AppController.initialize());

</script>

<div class="square-wrapper">
    <div class="square" onclick="showProfile()">
        <div class="burgerwrap">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>