#!/bin/bash

# Definisikan warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # Tanpa warna

echo -e "${CYAN}===================================${NC}"
echo -e "${GREEN}   SCRIPT PENGATURAN TTL OPENWRT   ${NC}"
echo -e "${CYAN}            By RTA-WRT             ${NC}"
echo -e "${CYAN}===================================${NC}"

# Fungsi untuk memvalidasi input numerik
validasi_angka() {
    if [[ "$1" =~ ^[0-9]+$ ]] && [ "$1" -ge 1 ] && [ "$1" -le 255 ]; then
        return 0
    else
        return 1
    fi
}

# Tanya nilai TTL yang diinginkan
while true; do
    read -p "Masukkan nilai TTL (1-255) [default: 65]: " nilai_ttl
    
    # Jika input kosong, gunakan default 65
    if [ -z "$nilai_ttl" ]; then
        nilai_ttl=65
        break
    fi
    
    # Validasi input
    if validasi_angka "$nilai_ttl"; then
        break
    else
        echo -e "${RED}Error: Masukkan angka antara 1-255${NC}"
    fi
done

# Konfirmasi sebelum melanjutkan
echo -e "\nAkan mengatur TTL dengan nilai: ${YELLOW}$nilai_ttl${NC}"
read -p "Lanjutkan? (y/n): " konfirmasi
if [[ "$konfirmasi" != "y" && "$konfirmasi" != "Y" ]]; then
    echo -e "${RED}Dibatalkan oleh pengguna${NC}"
    exit 1
fi

# Cek akses root
if [ "$(id -u)" != "0" ]; then
   echo -e "${RED}Script ini harus dijalankan sebagai root${NC}" 1>&2
   exit 1
fi

# Buat direktori jika belum ada
mkdir -p /etc/nftables.d

# Buat file rules baru
cat > /etc/nftables.d/99-ttl-fix.nft << EOF
#!/usr/sbin/nft -f

flush table ip mangle
add table ip mangle
add chain ip mangle mangle_prerouting { type filter hook prerouting priority 300; policy accept; }
add chain ip mangle mangle_postrouting { type filter hook postrouting priority 300; policy accept; }
add rule ip mangle mangle_prerouting counter ip ttl set $nilai_ttl
add rule ip mangle mangle_postrouting counter ip ttl set $nilai_ttl
EOF

# Set permissions
chmod 644 /etc/nftables.d/99-ttl-fix.nft

# Terapkan rules
echo -e "${BLUE}Menerapkan konfigurasi TTL...${NC}"
nft -f /etc/nftables.d/99-ttl-fix.nft

echo -e "\n=== ${GREEN}KONFIGURASI BERHASIL${NC} ==="
echo -e "TTL telah diatur ke nilai: ${YELLOW}$nilai_ttl${NC}"
echo -e "File konfigurasi: /etc/nftables.d/99-ttl-fix.nft"
echo -e "\nUntuk memeriksa rules yang aktif, jalankan: ${CYAN}nft list ruleset${NC}"
echo -e "Untuk memeriksa TTL, ping ke 8.8.8.8 dan periksa nilai TTL-nya"

# Tambahkan ke rc.local untuk mempertahankan setting setelah reboot
if ! grep -q "/etc/nftables.d/99-ttl-fix.nft" /etc/rc.local; then
    sed -i '/exit 0/i nft -f /etc/nftables.d/99-ttl-fix.nft' /etc/rc.local
    echo -e "${GREEN}Konfigurasi telah ditambahkan ke rc.local untuk bertahan setelah reboot${NC}"
fi